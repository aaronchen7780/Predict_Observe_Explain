---
title: "totalTime & Performance Analysis"
author: "Yu-An Chen"
date: "6/29/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE}
rm(list = ls())
library(devtools)
library(MASS)
library(dplyr)
library(lme4)
library(lmerTest)
library(ggplot2)
library(tidyr)
library(stringr)
```
# Performance Formatting and Matching
Reading and Removing unnecessary variables 
```{r}
df <- read.csv("SocialSp21.csv")
groupings <- read.csv("spring2021_groupAssignment.csv")
df_clean <- df[c(1,20,21,22)]
df_clean <- df_clean[-c(1),]

```

Standardizing Scores via Z-scores
```{r}
stdzscore <- function(inputData){
  inputData$z.A <- 0
  inputData$z.B <- 0
  inputData$z.C <- 0
  for(i in 2:4){
    sd <- sd(inputData[,i])
    miu <- mean(inputData[,i])
    for(j in 1:nrow(inputData)){
      inputData[,i+3][j] = (inputData[,i][j] - miu) / sd 
    }
  }
  names(inputData)[5] <- "Condition.A"
  names(inputData)[6] <- "Condition.B"
  names(inputData)[7] <- "Condition.C"
  return(inputData[c(1,5,6,7)])
}

df_clean <- stdzscore(df_clean)

```

Joining the datasets & renaming columns 
```{r}
df_joined <- left_join(df_clean, groupings)

names(df_joined)[2] <- "Baseline"
```

Assigning each observation to their conditions
```{r}
df_joined$Text <- 0
df_joined$POE <- 0


assign_conditions <- function(input){
  for(i in 1:nrow(input)){
    if(input$Group[i] == "Group A"){
      input$Text[i] = input$Condition.B[i]
      input$POE[i] = input$Condition.C[i]
    }
    else{
      input$Text[i] = input$Condition.C[i]
      input$POE[i] = input$Condition.B[i]      
    }
  }
  return(input)
}

df_final <- assign_conditions(df_joined)
df_final <- df_final[c(1,2,6,7)]
```


## Reading data & Preliminary Cleaning
```{r}
df <- read.csv('barPlot Data - Separated by semesters copy.csv')
df <- df[c(1,2,3,8)]

timeS21 <- read.csv('TimeData copy.csv')
timeS21 <- timeS21[c(1,2,3,8)]
names(timeS21)[2] <- "Semester"

df <- rbind(df, timeS21)

PerfF18 <- read.csv('F18Performance copy.csv')
PerfF19 <- read.csv('F19Performance copy.csv')
PerfS19 <- read.csv('S19Performance copy.csv')
PerfS20 <- read.csv('S20Performance copy.csv')
PerfS21 <- read.csv('S21Performance copy.csv')

PerfF18 <- na.omit(PerfF18)
PerfF19 <- na.omit(PerfF19)
PerfS19 <- na.omit(PerfS19)
PerfS20 <- na.omit(PerfS20)
PerfS21 <- na.omit(PerfS21)


df$timeOutlier <- 0
df$diff_from_baseline <- 0
df$condition <- as.factor(df$condition)

names(PerfS21)[names(PerfS21) == "AnonID"] <- "Student"
```


```{r}
##Dealing with cases where participants didn't participate in all conditions
checkCount <- function(input){
  input$counter <- 0
  for (i in 1:nrow(input)){
    for (j in 1:nrow(input)){
      if (input$AnonID[i] == input$AnonID[j]){
        input$counter[i] = input$counter[i] + 1
      }
    }
  }
  return(subset(input, counter == 3))
}

df <- checkCount(df)


TimeF18 <- subset(df, Semester == "Fall2018")
TimeF19 <- subset(df, Semester == "Fall2019")
TimeS19 <- subset(df, Semester == "Spring2019")
TimeS20 <- subset(df, Semester == "Spring2020")
TimeS21 <- subset(df, Semester == "Spring2021")
```

```{r}
## Making sure both time and performance data have the same observations
dropMissingPerf <- function(timedata, perfdata){
  perfdata$keep <- 0 
  for(i in 1:nrow(perfdata) ){
    if(any(timedata$AnonID == perfdata$Student[i])){
      perfdata$keep[i] = 1
    }
  }
  return(subset(perfdata, keep == 1))
}

dropMissingTime <- function(timedata, perfdata){
  timedata$keep <- 0
    for(i in 1:nrow(timedata) ){
    if(any(perfdata$Student == timedata$AnonID[i])){
      timedata$keep[i] = 1
      }
    }
  return(subset(timedata, keep == 1))
}


PerfF18 <- dropMissingPerf(TimeF18, PerfF18)
PerfF19 <- dropMissingPerf(TimeF19, PerfF19)
PerfS19 <- dropMissingPerf(TimeS19, PerfS19)
PerfS20 <- dropMissingPerf(TimeS20, PerfS20)
PerfS21 <- dropMissingPerf(TimeS21, PerfS21)

TimeF18 <- dropMissingTime(TimeF18, PerfF18)
TimeF19 <- dropMissingTime(TimeF19, PerfF19)
TimeS19 <- dropMissingTime(TimeS19, PerfS19)
TimeS20 <- dropMissingTime(TimeS20, PerfS20)
TimeS21 <- dropMissingTime(TimeS21, PerfS21)

```

## Marking Time outliers 
```{r}
exclude_outliers <- function(condData, destData){
  Q1 <- quantile(condData$totalTime, .25)
  Q3 <- quantile(condData$totalTime, .75)
  IQR <- IQR(condData$totalTime)
  upper <- Q3 + 1.5*IQR
  lower <- Q1 - 1.5*IQR
  
  for (i in 1:nrow(condData)){
    if (!(condData$totalTime[i] > lower & condData$totalTime[i] < upper)){
      index = which(destData$AnonID == condData$AnonID[i])
      for(j in 1:length(index)){
        change = index[j]
        destData$timeOutlier[change] = 1
      }
    }
  }
  return (destData)
}


po <- subset(TimeF18, condition == "PO")
poe <- subset(TimeF18,condition == "POE")
text <- subset(TimeF18, condition == "Text")

TimeF18 <- exclude_outliers(po, TimeF18)
TimeF18 <- exclude_outliers(poe, TimeF18)
TimeF18 <- exclude_outliers(text, TimeF18)


poe <- subset(TimeF19,condition == "POE")
pomc <- subset(TimeF19,condition == "POMC")
text <- subset(TimeF19,condition == "Text")

TimeF19 <- exclude_outliers(poe, TimeF19)
TimeF19 <- exclude_outliers(pomc, TimeF19)
TimeF19 <- exclude_outliers(text, TimeF19)


baseline <- subset(TimeS19,condition == "Baseline")
poe <- subset(TimeS19,condition == "POE")
text <- subset(TimeS19,condition == "Text")

TimeS19 <- exclude_outliers(baseline, TimeS19)
TimeS19 <- exclude_outliers(poe, TimeS19)
TimeS19 <- exclude_outliers(text, TimeS19)


baseline <- subset(TimeS20,condition == "Baseline")
poe <- subset(TimeS20,condition == "POE")
text <- subset(TimeS20,condition == "Text")

TimeS20 <- exclude_outliers(baseline, TimeS20)
TimeS20 <- exclude_outliers(poe, TimeS20)
TimeS20 <- exclude_outliers(text, TimeS20)


baseline <- subset(TimeS21, condition == "Baseline")
poe <- subset(TimeS21,condition == "POE")
text <- subset(TimeS21, condition == "Text")

TimeS21 <- exclude_outliers(baseline, TimeS21)
TimeS21 <- exclude_outliers(poe, TimeS21)
TimeS21 <- exclude_outliers(text, TimeS21)

```


## Marking performance outliers 
```{r}
get_upper <- function(dfcondition){
    Q1 <- quantile(dfcondition, .25)
    Q3 <- quantile(dfcondition, .75)
    IQR <- IQR(dfcondition)
    upper <-Q3 + 1.5*IQR
    return(upper)
}

get_lower <- function(dfcondition){
    Q1 <- quantile(dfcondition, .25)
    Q3 <- quantile(dfcondition, .75)
    IQR <- IQR(dfcondition)
    lower <- Q3 - 1.5*IQR
    return(lower)
}

remove_outliers <- function(input, upper1, lower1, upper2, lower2, upper3, lower3){
  input <- na.omit(input)
  input$perfOutlier <- 0
  for(i in 1:nrow(input)){
    if (input[2][i,] > upper1 | input[2][i,] < lower1){
      input$perfOutlier[i] = 1
    }
    if (input[3][i,] > upper2 | input[3][i,] < lower2){
      input$perfOutlier[i] = 1
    }
    if (input[4][i,] > upper3 | input[4][i,] < lower3){
      input$perfOutlier[i] = 1
    }
  }
  return (input)
}


PerfF18 <- remove_outliers(PerfF18, get_upper(PerfF18$PO), get_lower(PerfF18$PO), get_upper(PerfF18$POE), get_lower(PerfF18$POE),  get_upper(PerfF18$Text), get_lower(PerfF18$Text))


PerfF19 <- remove_outliers(PerfF19, get_upper(PerfF19$PO...MC), get_lower(PerfF19$PO...MC), get_upper(PerfF19$POE), get_lower(PerfF19$POE),  get_upper(PerfF19$Text), get_lower(PerfF19$Text))


PerfS19 <- remove_outliers(PerfS19, get_upper(PerfS19$Baseline), get_lower(PerfS19$Baseline), get_upper(PerfS19$Control), get_lower(PerfS19$Control),  get_upper(PerfS19$Experimental), get_lower(PerfS19$Experimental))

PerfS20 <- remove_outliers(PerfS20, get_upper(PerfS20$baseline), get_lower(PerfS20$baseline), get_upper(PerfS20$control), get_lower(PerfS20$control),  get_upper(PerfS20$experimental), get_lower(PerfS20$experimental))

PerfS21 <- remove_outliers(PerfS21, get_upper(PerfS21$Baseline), get_lower(PerfS21$Baseline), get_upper(PerfS21$Text), get_lower(PerfS21$Text),  get_upper(PerfS21$POE), get_lower(PerfS21$POE))
```

## Extracting outlier-removed datasets for both time and performance 
```{r}
cleanTime <- function(timedata, perfdata){
  timedata$overallOutlier <- 0
  for(i in 1:nrow(timedata)){
    if(timedata$timeOutlier[i] == 1){
      timedata$overallOutlier[i] = 1
    }
  }
  for(j in 1:nrow(perfdata)){
    if(perfdata$perfOutlier[j] == 1){
      index = which(timedata$AnonID == perfdata$Student[j])
      for(k in 1:length(index)){
        change = index[k]
        timedata$overallOutlier[change] = 1
      }
    }
  }
  return(subset(timedata, overallOutlier == 0))
}

cleanPerf <- function(timedata, perfdata){
  perfdata$overallOutlier <- 0
  for(i in 1:nrow(perfdata)){
    if(perfdata$perfOutlier[i] == 1){
      perfdata$overallOutlier[i] = 1
    }
  }
  for(j in 1:nrow(timedata)){
    if(timedata$timeOutlier[j] == 1){
      index = which(perfdata$AnonID == timedata$Student[j])
      for(k in 1:length(index)){
        change = index[k]
        perfdata$overallOutlier[change] = 1
      }
    }
  }
  return(subset(perfdata, overallOutlier == 0))
}

PerfF18_cleaned <- cleanPerf(TimeF18, PerfF18)
PerfF19_cleaned <- cleanPerf(TimeF19, PerfF19)
PerfS19_cleaned <- cleanPerf(TimeS19, PerfS19)
PerfS20_cleaned <- cleanPerf(TimeS20, PerfS20)
PerfS21_cleaned <- cleanPerf(TimeS21, PerfS21)

TimeF18_cleaned <- cleanTime(TimeF18, PerfF18)
TimeF19_cleaned <- cleanTime(TimeF19, PerfF19)
TimeS19_cleaned <- cleanTime(TimeS19, PerfS19)
TimeS20_cleaned <- cleanTime(TimeS20, PerfS20)
TimeS21_cleaned <- cleanTime(TimeS21, PerfS21)
```

## Time Plots
```{r}

TimePlotF18 <- ggplot(TimeF18_cleaned, aes(x = condition, y=totalTime, color = condition)) + 
  geom_violin() + labs(title="Fall 2018 excluding outliers")

TimePlotF19 <- ggplot(TimeF19_cleaned, aes(x = condition, y=totalTime, color = condition)) + 
  geom_violin() + labs(title="Fall 2019 excluding outliers")

TimePlotS19 <- ggplot(TimeS19_cleaned, aes(x = condition, y=totalTime, color = condition)) + 
  geom_violin() + labs(title="Spring 2019 excluding outliers")

TimePlotS20 <- ggplot(TimeS20_cleaned, aes(x = condition, y=totalTime, color = condition)) + 
  geom_violin() + labs(title="Spring 2020 excluding outliers")

TimePlotS21 <- ggplot(TimeS21_cleaned, aes(x = condition, y=totalTime, color = condition)) + 
  geom_violin() + labs(title="Spring 2021 excluding outliers")

TimePlotF18
TimePlotF19
TimePlotS19
TimePlotS20
TimePlotS21

```

## Time Significance testing: Creating difference from baseline values
```{r}

baseline_diff <- function(input, condA){
  input$diff_from_baseline <- 0
  for(i in 1:nrow(input)){
  if(input$condition[i] != condA){
    for(j in 1:nrow(input)){
      if(input$AnonID[i] == input$AnonID[j] &
         input$condition[j] == condA){
        baseVal = input$totalTime[j]
      }
    }
    
    input$diff_from_baseline[i] = 
      baseVal - input$totalTime[i]
    }
  }
  return(input)
}

TimeF18_cleaned <- baseline_diff(TimeF18_cleaned, "Text")
TimeF19_cleaned <- baseline_diff(TimeF19_cleaned, "Text")
TimeS19_cleaned <- baseline_diff(TimeS19_cleaned, "Baseline")
TimeS20_cleaned <- baseline_diff(TimeS20_cleaned, "Baseline")
TimeS21_cleaned <- baseline_diff(TimeS21_cleaned, "Baseline")

```

# Time: Plots of difference from baseline
```{r}
TimeDiffPlot <- function(input, condA, condB, sem){
  a <- subset(input, condition == condA)
  b <- subset(input, condition == condB)
  final <- data.frame(Type = c(paste("Baseline -", condA, sep = " ") , paste("Baseline -", condB, sep = " ")), diff_from_baseline = c(mean(a$diff_from_baseline), mean(b$diff_from_baseline)))
  
  return(ggplot(data=final, aes(x=Type, y=diff_from_baseline)) +
  geom_col(width = 0.55)+ labs(y="Time difference from Baseline (min)", x = "Group",
              title = paste("Avg. Difference from Baseline Condition", sem, sep = " ")))
  
}

TimeDiffPlot(TimeF18_cleaned, "PO", "POE", "(Fall 2018)")
TimeDiffPlot(TimeF19_cleaned, "POE", "POMC", "(Fall 2019)")
TimeDiffPlot(TimeS19_cleaned, "POE", "Text", "(Spring 2019)")
TimeDiffPlot(TimeS20_cleaned, "POE", "Text", "(Spring 2020)")
TimeDiffPlot(TimeS21_cleaned, "POE", "Text", "(Spring 2021)")
```

# Time: Paired T-tests
```{r}
ttest <- function(input, condA, condB){
  first <- subset(input, condition == condA)
  second <- subset(input, condition == condB)
  return(t.test(first$diff_from_baseline, second$diff_from_baseline, paired = TRUE, alternative = "two.sided"))
}

ttest(TimeF18_cleaned, "PO", "POE")
ttest(TimeF19_cleaned, "POE", "POMC")
ttest(TimeS19_cleaned, "POE", "Text")
ttest(TimeS20_cleaned, "POE", "Text")
ttest(TimeS21_cleaned, "POE", "Text")


```

# Time: Relevant LMER models
```{r}

lmerModel <- function(input, refcond){
  return(lmer(totalTime ~ condition + (1|AnonID), data = input))
}

TimeF18lmer <- lmer(totalTime ~ relevel(condition, ref = "Text") + (1 |AnonID), data= TimeF18_cleaned)
summary(TimeF18lmer)

TimeF19lmer <- lmer(totalTime ~ relevel(condition, ref = "Text") + (1 |AnonID), data= TimeF19_cleaned)
summary(TimeF19lmer)

TimeS19lmer <- lmer(totalTime ~ relevel(condition, ref = "Baseline") + (1 |AnonID), data= TimeS19_cleaned)
summary(TimeS19lmer)

TimeS20lmer <- lmer(totalTime ~ relevel(condition, ref = "Baseline") + (1 |AnonID), data= TimeS20_cleaned)
summary(TimeS20lmer)

TimeS21lmer <- lmer(totalTime ~ relevel(condition, ref = "Baseline") + (1 |AnonID), data= TimeS21_cleaned)
summary(TimeS21lmer)

```

## Time: Extended Tests
```{r}
ttestExtended <- function(input, condA, condB){
  first <- subset(input, condition == condA)
  second <- subset(input, condition == condB)
  return(t.test(first$totalTime, second$totalTime, paried = TRUE, alternative = "two.sided"))
}

ttestExtended(TimeF19_cleaned, "POE", "Text")
ttestExtended(TimeS19_cleaned, "POE", "Text")
ttestExtended(TimeS20_cleaned, "POE", "Text")

```


## Performance 

To prepare the data so that it becomes an acceptable df for the violin plots, we will transform the data from wide into long form. Also note that we're setting factor_key to TRUE in our gather function so that we can re-level our reference conditions in the later LMER tests.
```{r}
gather_to_long <- function(df, cond1, cond2, cond3){
  keycol <- "condition"
  valuecol <- "zscore"
  gathercols <- c(cond1, cond2, cond3)
  return (gather_(df, keycol, valuecol, gathercols, factor_key = TRUE))
}

PerfF18long <- gather_to_long(PerfF18_cleaned, "PO", "POE", "Text")
PerfF19long <- gather_to_long(PerfF19_cleaned, "POE", "PO...MC", "Text.Only")
PerfS19long <- gather_to_long(PerfS19_cleaned, "Baseline", "Control", "Experimental")
PerfS20long <- gather_to_long(PerfS20_cleaned, "baseline", "control", "experimental")
PerfS21long <- gather_to_long(PerfS21_cleaned, "Baseline", "Text", "POE")
```


## Performance: Plotting Distributions

We will first plot the distributions of the data using a violin plot to determine if we will need to further deal with outliers or do data transformations

Fall 2018 Densities: 
```{r}
F18Violin <- ggplot(PerfF18long,aes(x=condition, y = zscore, color = condition)) + 
  geom_violin() + labs(title="F18Violin")
F18Violin
```

Fall 2019 Densities:
```{r}
F19Violin <- ggplot(PerfF19long,aes(x=condition, y = zscore, color = condition)) + 
  geom_violin() + labs(title="F19Violin")
F19Violin
```

Spring 2019 Densities:
```{r}
S19Violin <- ggplot(PerfS19long,aes(x=condition, y = zscore, color = condition)) + 
  geom_violin() + labs(title="S19Violin")
S19Violin
```

Spring 2020 Densities:
```{r}
S20Violin <- ggplot(PerfS20long,aes(x=condition, y = zscore, color = condition)) + 
  geom_violin() + labs(title="S20Violin")
S20Violin
```
Spring 2021 Densities:
```{r}
S21Violin <- ggplot(PerfS21long,aes(x=condition, y = zscore, color = condition)) + 
  geom_violin() + labs(title="S21Violin")
S21Violin
```

## Performance: Creating Results

To find out how many z-scores away from the mean each condition results for the students, we will take the average of the z-scores in each condition for each semester

```{r}

ResultsF18_cleaned <- data.frame(Type = c("PO", "POE", "Text"), Avg = c(mean(PerfF18_cleaned$PO), mean(PerfF18_cleaned$POE), mean(PerfF18_cleaned$Text)))

ResultsF19_cleaned <- data.frame(Type = c("POMC", "POE", "Text"), Avg = c(mean(PerfF19_cleaned$PO...MC), mean(PerfF19_cleaned$POE), mean(PerfF19_cleaned$Text)))

ResultsS19_cleaned <- data.frame(Type = c("Baseline", "Control", "Experimental"), Avg = c(mean(PerfS19_cleaned$Baseline), mean(PerfS19_cleaned$Control), mean(PerfS19_cleaned$Experimental)))

ResultsS20_cleaned <- data.frame(Type = c("Baseline", "Control", "Experimental"), Avg = c(mean(PerfS20_cleaned$baseline), mean(PerfS20_cleaned$control), mean(PerfS20_cleaned$experimental)))

ResultsS21_cleaned <- data.frame(Type = c("Baseline", "Text", "POE"), Avg = c(mean(PerfS21_cleaned$Baseline), mean(PerfS21_cleaned$Text), mean(PerfS21_cleaned$POE)))


F18plot <- ggplot(data=ResultsF18_cleaned, aes(x=Type, y=Avg)) +
  geom_col(width = 0.65)+ labs(y="z-score deviation from Mean", x = "Group",
              title = "Avg. Z-score Difference from Mean (Fall 2018 cleaned)")

F19plot <- ggplot(data=ResultsF19_cleaned, aes(x=Type, y=Avg)) +
  geom_col(width = 0.65)+ labs(y="z-score deviation from Mean", x = "Group",
              title = "Avg. Z-score Difference from Mean (Fall 2019 cleaned)")

S19plot <- ggplot(data=ResultsS19_cleaned, aes(x=Type, y=Avg)) +
  geom_col(width = 0.65)+ labs(y="z-score deviation from Mean", x = "Group",
              title = "Avg. Z-score Difference from Mean (Spring 2019 cleaned)")

S20plot <- ggplot(data=ResultsS20_cleaned, aes(x=Type, y=Avg)) +
  geom_col(width = 0.65)+ labs(y="z-score deviation from Mean", x = "Group",
              title = "Avg. Z-score Difference from Mean (Spring 2020 cleaned)")

S21plot <- ggplot(data=ResultsS21_cleaned, aes(x=Type, y=Avg)) +
  geom_col(width = 0.65)+ labs(y="z-score deviation from Mean", x = "Group",
              title = "Avg. Z-score Difference from Mean (Spring 2021 cleaned)")




F18plot
F19plot
S19plot
S20plot
S21plot
```

## Performance: Difference From Baseline
Here we will conduct both a simple two sample t-test and an lmer regression to determine if the differences from the baseline are significant

**Creating differences columns**
```{r}
make_differences <- function(df, baselineCol){
  df$diffFromBase1 <- 0
  df$diffFromBase2 <- 0
  if(baselineCol == 4){
    for(i in 1:nrow(df)){
      df$diffFromBase1[i] = df[baselineCol][i,] - df[2][i,]
      df$diffFromBase2[i] = df[baselineCol][i,] - df[3][i,]
    }
  }
  else if(baselineCol == 2){
    for(i in 1:nrow(df)){
      df$diffFromBase1[i] = df[baselineCol][i,] - df[3][i,]
      df$diffFromBase2[i] = df[baselineCol][i,] - df[4][i,]
    }
  }
  return(df)
}


PerfF18_cleaned <- make_differences (PerfF18_cleaned, 4)
PerfF19_cleaned <- make_differences (PerfF19_cleaned, 4)
PerfS19_cleaned <- make_differences (PerfS19_cleaned, 2)
PerfS20_cleaned <- make_differences (PerfS20_cleaned, 2)
PerfS21_cleaned <- make_differences (PerfS21_cleaned, 2)
```

**Plots of the differences**

```{r}

diffResultsF18 <- data.frame(Type = c("Baseline - PO", "Baseline - POE"), Avg = c(mean(PerfF18_cleaned$diffFromBase1), mean(PerfF18_cleaned$diffFromBase2)))

diffResultsF19 <- data.frame(Type = c("Baseline - POMC", "Baseline - POE"), Avg = c(mean(PerfF19_cleaned$diffFromBase1), mean(PerfF19_cleaned$diffFromBase2)))

diffResultsS19 <- data.frame(Type = c("Baseline - Control", "Baseline - Experimental"), Avg = c(mean(PerfS19_cleaned$diffFromBase1), mean(PerfS19_cleaned$diffFromBase2)))

diffResultsS20_ <- data.frame(Type = c("Baseline - Control", "Baseline - Experimental"), Avg = c(mean(PerfS20_cleaned$diffFromBase1), mean(PerfS20_cleaned$diffFromBase2)))

diffResultsS21_ <- data.frame(Type = c("Baseline - Control", "Baseline - Experimental"), Avg = c(mean(PerfS21_cleaned$diffFromBase1), mean(PerfS21_cleaned$diffFromBase2)))


diffPlotF18 <- ggplot(data=diffResultsF18, aes(x=Type, y=Avg)) +
  geom_col(width = 0.6)+ labs(y="baseline - condition", x = "Group",
              title = "Z-score Difference from Baseline (Fall 2018)")

diffPlotF19 <- ggplot(data=diffResultsF19, aes(x=Type, y=Avg)) +
  geom_col(width = 0.6)+ labs(y="baseline - condition", x = "Group",
              title = "Z-score Difference from Baseline (Fall 2019)")

diffPlotS19 <- ggplot(data=diffResultsS19, aes(x=Type, y=Avg)) +
  geom_col(width = 0.6)+ labs(y="baseline - condition", x = "Group",
              title = "Z-score Difference from Baseline (Spring 2019)")

diffPlotS20 <- ggplot(data=diffResultsS20_, aes(x=Type, y=Avg)) +
  geom_col(width = 0.6)+ labs(y="baseline - condition", x = "Group",
              title = "Z-score Difference from Baseline (Spring 2020)")

diffPlotS21 <- ggplot(data=diffResultsS21_, aes(x=Type, y=Avg)) +
  geom_col(width = 0.6)+ labs(y="baseline - condition", x = "Group",
              title = "Z-score Difference from Baseline (Spring 2021)")

diffPlotF18
diffPlotF19
diffPlotS19
diffPlotS20
diffPlotS21
```

## Performance: Paired t-tests

Below are the summaries of the paired t-tests. None of the performance differences are significant at the alpha = 0.05 level.
```{r}
t.test(PerfF18_cleaned$diffFromBase1, PerfF18_cleaned$diffFromBase2, paired = TRUE, alternative = "two.sided")
t.test(PerfF19_cleaned$diffFromBase1, PerfF19_cleaned$diffFromBase2, paired = TRUE, alternative = "two.sided")
t.test(PerfS19_cleaned$diffFromBase1, PerfS19_cleaned$diffFromBase2, paired = TRUE, alternative = "two.sided")
t.test(PerfS20_cleaned$diffFromBase1, PerfS20_cleaned$diffFromBase2, paired = TRUE, alternative = "two.sided")
t.test(PerfS21_cleaned$diffFromBase1, PerfS21_cleaned$diffFromBase2, paired = TRUE, alternative = "two.sided")
```

## Performance: Condition LMER
Now for further analysis, we will run a linear mixed-effect model on the differences between the differences from the baseline conditions. To do this, we will need to apply the new changes to our long data format and remove the baseline conditions so our comparison can be made on the differences from the baseline.
```{r}

PerfF18long <- gather_to_long(PerfF18_cleaned, "PO", "POE", "Text")
PerfF19long <- gather_to_long(PerfF19_cleaned, "POE", "PO...MC", "Text.Only")
PerfS19long <- gather_to_long(PerfS19_cleaned, "Baseline", "Control", "Experimental")
PerfS20long <- gather_to_long(PerfS20_cleaned, "baseline", "control", "experimental")
PerfS21long <- gather_to_long(PerfS21_cleaned, "Baseline", "Text", "POE")

remove_base <- function(input, baseCond){
  return(subset(input, condition != baseCond))
}

F18lmer <- lmer(zscore ~  relevel(condition, ref = "Text") + (1 |Student), data= PerfF18long)
summary(F18lmer)


F19lmer <- lmer(zscore ~ relevel(condition, ref = "Text.Only") + (1 |Student), data= PerfF19long)
summary(F19lmer)


S19lmer <- lmer(zscore ~ condition + (1 |Student), data= PerfS19long)
summary(S19lmer)


S20lmer <- lmer(zscore ~ condition + (1 |Student), data= PerfS20long)
summary(S20lmer)

S21lmer <- lmer(zscore ~ condition + (1 |Student), data= PerfS21long)
summary(S21lmer)

```
## Performance: Z-Score differences from baseline LMER
We will now look at another LMER analysis, where we test for the differences in zscore differences from the baseline conditions. To do this, we will first extract the values (diffFromBase1 and diffFromBase2) from our cleaned performance data sets, then populate the new dataframe with the differences from baseline, conditions, and the Student IDs. 
```{r}

new <- function(input, condA, condB){
  arr <- NULL
  arrlen <- 1
  for(i in 1:nrow(input)){
    arr[arrlen] <- input[i,ncol(input)-1]
    arr[arrlen + 1] <- input[i,ncol(input)]
    arrlen <- arrlen + 2
  }
  final <- data.frame(zscore_deviation = c(arr))
  final$condition <- 0
  final$Student <- 0
  
  for(j in 1:nrow(final)){
    if(j%%2 == 1){
      final$condition[j] = condA
      final$Student[j] = input$Student[(j/2) + 1]
    }
    else{
      final$condition[j] = condB
      final$Student[j] = input$Student[j/2]
    }
  }
  return(final)
}

ZDiff_F18 <- new(PerfF18_cleaned, "PO", "POE")
ZDiff_F19 <- new(PerfF19_cleaned, "POMC", "POE")
ZDiff_S19 <- new(PerfS19_cleaned, "Control", "Experimental")
ZDiff_S20 <- new(PerfS20_cleaned, "Control", "Experimental")
ZDiff_S21 <- new(PerfS21_cleaned, "Text", "POE")

ZD_F18Results <- lmer(zscore_deviation ~  condition + (1 |Student), data= ZDiff_F18)
summary(ZD_F18Results)

ZD_F19Results <- lmer(zscore_deviation ~  condition + (1 |Student), data= ZDiff_F19)
summary(ZD_F19Results)

ZD_S19Results <- lmer(zscore_deviation ~  condition + (1 |Student), data= ZDiff_S19)
summary(ZD_S19Results)

ZD_S20Results <- lmer(zscore_deviation ~  condition + (1 |Student), data= ZDiff_S20)
summary(ZD_S20Results)

ZD_S21Results <- lmer(zscore_deviation ~  condition + (1 |Student), data= ZDiff_S21)
summary(ZD_S21Results)

```
## Performance: Extended t-tests
We would like to know a little bit about the differences between POE and text conditions in Fall 2019 and Spring 2020 because the questions given in the PO+MC conditions may have been lacking in overall quality. We will run standard t-tests between the two conditions in these semesters
```{r}
t.test(PerfF19_cleaned$POE, PerfF19_cleaned$Text.Only, paired = TRUE, alternative = "two.sided")
t.test(PerfS20_cleaned$control, PerfS20_cleaned$experimental, paired = TRUE, alternative = "two.sided")
```


## Data Analysis: Gain per minute

Now we want to normalize performance by time to determine how much "performance" students earn for every minute in their condition. To do this, we will divide each student's z-score performance by the completion time


```{r}
calculate_gains <- function(perfdata, timedata){
  perfdata$gain_per_min <- 0
  column <- 0
  for(i in 1:nrow(perfdata)){
    for(j in 1:nrow(timedata)){
      if(perfdata$Student[i] == timedata$AnonID[j]){
        column = j
      }
    }
    perfdata$gain_per_min[i] = perfdata$zscore[i]/timedata$totalTime[column]
  }
  return(perfdata)
}

PerfF18long <- gather_to_long(PerfF18_cleaned, "PO", "POE", "Text")
PerfF19long <- gather_to_long(PerfF19_cleaned, "POE", "PO...MC", "Text.Only")
PerfS19long <- gather_to_long(PerfS19_cleaned, "Baseline", "Control", "Experimental")
PerfS20long <- gather_to_long(PerfS20_cleaned, "baseline", "control", "experimental")
PerfS21long <- gather_to_long(PerfS21_cleaned, "Baseline", "Text", "POE")

PerfF18long <- calculate_gains(PerfF18long, TimeF18)
PerfF19long <- calculate_gains(PerfF19long, TimeF19)
PerfS19long <- calculate_gains(PerfS19long, TimeS19)
PerfS20long <- calculate_gains(PerfS20long, TimeS20)
PerfS21long <- calculate_gains(PerfS21long, TimeS21)

```

To see the average gains across conditions, we will create barplots for visualization.

```{r}

a1<-mean(subset(PerfF18long, condition == "PO")$gain_per_min)
a2<-mean(subset(PerfF18long, condition == "POE")$gain_per_min)
a3<-mean(subset(PerfF18long, condition == "Text")$gain_per_min)

a4<-mean(subset(PerfF19long, condition == "POE")$gain_per_min)
a5<-mean(subset(PerfF19long, condition == "PO...MC")$gain_per_min)
a6<-mean(subset(PerfF19long, condition == "Text.Only")$gain_per_min)

a7<-mean(subset(PerfS19long, condition == "Baseline")$gain_per_min)
a8<-mean(subset(PerfS19long, condition == "Control")$gain_per_min)
a9<-mean(subset(PerfS19long, condition == "Experimental")$gain_per_min)

a10<-mean(subset(PerfS20long, condition == "baseline")$gain_per_min)
a11<-mean(subset(PerfS20long, condition == "control")$gain_per_min)
a12<-mean(subset(PerfS20long, condition == "experimental")$gain_per_min)

a13<-mean(subset(PerfS21long, condition == "Baseline")$gain_per_min)
a14<-mean(subset(PerfS21long, condition == "Text")$gain_per_min)
a15<-mean(subset(PerfS21long, condition == "POE")$gain_per_min)


perfResultsF18 <- data.frame(Type = c("PO", "POE", "Text"), Avg = c(a1, a2, a3))
perfResultsF19 <- data.frame(Type = c("POE", "POMC", "Text"), Avg = c(a4, a5, a6))
perfResultsS19 <- data.frame(Type = c("Baseline", "Control(Text)", "Experimental (POE)"), Avg = c(a7, a8, a9))
perfResultsS20 <- data.frame(Type = c("Baseline", "Control(Text)", "Experimental (POE)"), Avg = c(a10, a11, a12))
perfResultsS21 <- data.frame(Type = c("Baseline", "Control(Text)", "Experimental (POE)"), Avg = c(a13, a14, a15))


perfPlotF18 <- ggplot(data=perfResultsF18, aes(x=Type, y=Avg)) +
  geom_col(width = 0.6)+ labs(y="gain per minute", x = "Group",
              title = "Z-score gain per minute (Fall 2018 cleaned)")

perfPlotF19 <- ggplot(data=perfResultsF19, aes(x=Type, y=Avg)) +
  geom_col(width = 0.6)+ labs(y="gain per minute", x = "Group",
              title = "Z-score gain per minute (Fall 2019 cleaned)")

perfPlotS19 <- ggplot(data=perfResultsS19, aes(x=Type, y=Avg)) +
  geom_col(width = 0.6)+ labs(y="gain per minute", x = "Group",
              title = "Z-score gain per minute (Spring 2019 cleaned)")

perfPlotS20 <- ggplot(data=perfResultsS20, aes(x=Type, y=Avg)) +
  geom_col(width = 0.6)+ labs(y="gain per minute", x = "Group",
              title = "Z-score gain per minute (Spring 2020 cleaned)")


perfPlotS21 <- ggplot(data=perfResultsS21, aes(x=Type, y=Avg)) +
  geom_col(width = 0.6)+ labs(y="gain per minute", x = "Group",
              title = "Z-score gain per minute (Spring 2021 cleaned)")

perfPlotF18
perfPlotF19
perfPlotS19
perfPlotS20
perfPlotS21
```

## T-tests: Gain per minute
Now we will see if the gains per minute are significantly different between the conditions

```{r}

gain_diff_create<- function(df, baseline){
  df$gain_diff <- 0
  for(i in 1:nrow(df)){
    if(df$condition[i] != baseline){
      checkRow = which(df$condition == baseline & df$Student == df$Student[i])
      df$gain_diff[i] = df$gain_per_min[checkRow] - df$gain_per_min[i]
    }
  }
  return(df)
}



PerfF18long <- gain_diff_create(PerfF18long, "Text")
PerfF19long <- gain_diff_create(PerfF19long, "Text.Only")
PerfS19long <- gain_diff_create(PerfS19long, "Baseline")
PerfS20long <- gain_diff_create(PerfS20long, "baseline")
PerfS21long <- gain_diff_create(PerfS21long, "Baseline")

po <- subset(PerfF18long, condition == "PO")
poe <- subset(PerfF18long, condition == "POE")
t.test(po$gain_diff, poe$gain_diff, paired = TRUE, alternative = "two.sided")

pomc <- subset(PerfF19long, condition == "PO...MC")
poe <- subset(PerfF19long, condition == "POE")
t.test(poe$gain_diff, pomc$gain_diff, paired = TRUE, alternative = "two.sided")

control <- subset(PerfS19long, condition == "Control")
experimental <- subset(PerfS19long, condition == "Experimental")
t.test(control$gain_diff, experimental$gain_diff, paired = TRUE, alternative = "two.sided")

control <- subset(PerfS20long, condition == "control")
experimental <- subset(PerfS20long, condition == "experimental")
t.test(control$gain_diff, experimental$gain_diff, paired = TRUE, alternative = "two.sided")

control <- subset(PerfS21long, condition == "Text")
experimental <- subset(PerfS21long, condition == "POE")
t.test(control$gain_diff, experimental$gain_diff, paired = TRUE, alternative = "two.sided")

```

# Gain Per Min: LMER
```{r}
PerfF18long <- remove_base(PerfF18long, "Text")
PerfF19long <- remove_base(PerfF19long, "Text.Only")
PerfS19long <- remove_base(PerfS19long, "Baseline")
PerfS20long <- remove_base(PerfS20long, "baseline")
PerfS21long <- remove_base(PerfS21long, "Baseline")


F18lmer_gain <- lmer(gain_diff ~ condition + (1 |Student), data= PerfF18long)
summary(F18lmer_gain)


F19lmer_gain <- lmer(gain_diff ~ condition + (1 |Student), data= PerfF19long)
summary(F19lmer_gain)


S19lmer_gain <- lmer(gain_diff ~ condition + (1 |Student), data= PerfS19long)
summary(S19lmer_gain)


S20lmer_gain <- lmer(gain_diff ~ condition + (1 |Student), data= PerfS20long)
summary(S20lmer_gain)

S21lmer_gain <- lmer(gain_diff ~ condition + (1 |Student), data= PerfS21long)
summary(S21lmer_gain)


```


# Raw Data Analysis: 
```{r}
install.packages("openNLP") ## Installs the required natural language processing (NLP) package
install.packages("openNLPmodels.en") ## Installs the model files for the English language
library(openNLP) ## Loads the package for use in the task
library(openNLPmodels.en) ## Loads the model files for the English language
test <- read.delim("Cognitive Dissonance Read Only.txt")

test2 <- readChar("Cognitive Dissonance Read Only.txt", file.info("Cognitive Dissonance Read Only.txt")$size)

count_sentences <- function(df){
  final <- ""
  for (i in 1:nrow(df)){
    final = paste(final, df[i,1])
  }
 return (length(gregexpr('[[:alnum:] ][.!?]', final)[[1]]))  
}

count_sentences(test)

text <- 'Hello world!! Here are two sentences for you...'
length(gregexpr('[[:alnum:] ][.!?]', text)[[1]])
```